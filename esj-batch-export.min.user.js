// ==UserScript==
// @name         ESJ ç›®éŒ„æ‰¹æ¬¡ä¸‹è¼‰ TXTï¼ˆé è¨­ ZIPï¼‰
// @namespace    esj-batch-export
// @version      1.3
// @description  åœ¨å°èªªç›®éŒ„é å‹¾é¸ç« ç¯€ä¸¦ç›´æ¥ ZIP æ‰¹æ¬¡ä¸‹è¼‰ TXT
// @match        https://www.esjzone.cc/detail/*.html
// @grant        none
// @require      https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js
// @downloadURL  https://raw.githubusercontent.com/sakakibara-yoichi/esj-novel-batch-export/master/esj-batch-export.min.user.js
// @updateURL    https://raw.githubusercontent.com/sakakibara-yoichi/esj-novel-batch-export/master/esj-batch-export.min.user.js
// ==/UserScript==
!async function(){"use strict";const t=Array.from(document.querySelectorAll('#chapterList a[href*="/forum/"]')).filter(t=>t.textContent.trim().length>0);if(0===t.length)return;const e=document.createElement("div");e.textContent="ğŸ“˜",e.title="ä¸‹è¼‰ç« ç¯€ TXT",Object.assign(e.style,{position:"fixed",right:"20px",bottom:"20px",zIndex:9999,cursor:"pointer",fontSize:"28px",background:"#fff",border:"1px solid #aaa",borderRadius:"50%",width:"48px",height:"48px",display:"flex",alignItems:"center",justifyContent:"center",boxShadow:"0 2px 6px rgba(0,0,0,.3)"}),document.body.appendChild(e);const n=document.createElement("div");Object.assign(n.style,{position:"fixed",right:"20px",bottom:"80px",zIndex:9999,background:"#fff",border:"1px solid #aaa",padding:"10px",width:"320px",maxHeight:"60vh",overflowY:"auto",fontSize:"14px",display:"none",boxShadow:"0 2px 8px rgba(0,0,0,.3)"});const o=document.createElement("button");o.textContent="ğŸ“¦ ä¸‹è¼‰é¸å–ç« ç¯€ï¼ˆZIPï¼‰",o.style.width="100%",o.style.marginBottom="8px";const i=document.createElement("button");i.textContent="âœ… å…¨é¸",i.style.width="100%",i.style.marginBottom="6px",n.appendChild(i),n.appendChild(o),n.appendChild(document.createElement("hr"));const l=document.createElement("label");l.style.display="block",l.style.marginBottom="8px",l.style.cursor="pointer";const c=document.createElement("input");c.type="checkbox",c.style.marginRight="6px",l.appendChild(c),l.appendChild(document.createTextNode("âš¡ åŠ é€Ÿæ¨¡å¼ï¼ˆä½µç™¼ä¸‹è¼‰ï¼‰")),n.appendChild(l);const r=document.createElement("div");r.style.display="none";const a=document.createElement("div");a.style.fontSize="12px",a.style.marginBottom="4px";const d=document.createElement("div");d.style.fontSize="12px",d.style.color="#666",d.style.marginBottom="4px",d.textContent="å‰©é¤˜æ™‚é–“ï¼šè¨ˆç®—ä¸­â€¦";const s=document.createElement("div");s.style.fontSize="12px",s.style.color="#c62828",s.style.marginTop="6px",s.style.display="none";const p=document.createElement("div");p.style.fontSize="12px",p.style.color="#555",p.style.marginBottom="4px",p.textContent="ç›®å‰ç« ç¯€ï¼šâ€”";const m=document.createElement("div");Object.assign(m.style,{width:"100%",height:"10px",background:"#eee",borderRadius:"5px",overflow:"hidden"});const h=document.createElement("div");Object.assign(h.style,{height:"100%",width:"0%",background:"#4caf50",transition:"width .2s"}),m.appendChild(h),r.appendChild(a),r.appendChild(m),r.insertBefore(p,a),r.insertBefore(d,a),r.appendChild(s),n.appendChild(r);const x=[];async function u(t){const e=await fetch(t).then(t=>t.text()),n=(new DOMParser).parseFromString(e,"text/html"),o=(n.title||"æœªå‘½åç« ç¯€").replace(" - ESJ Zone","").trim(),i=n.querySelector("div.forum-content.mt-3");if(!i)return null;i.querySelectorAll("script, style, img").forEach(t=>t.remove());return{title:o,text:`${o}\n\n${i.innerText.split("\n").map(t=>t.trim()).filter(Boolean).join("\n")}`}}function y(t,e){const n=Math.floor(t/e*100);h.style.width=n+"%",a.textContent=`ä¸‹è¼‰ä¸­ï¼š${t} / ${e}ï¼ˆ${n}%ï¼‰`}function f(t,e,n){if(0===t)return;const o=(Date.now()-n)/1e3/t,i=Math.max(0,Math.round(o*(e-t))),l=Math.floor(i/60),c=i%60;d.textContent=`å‰©é¤˜æ™‚é–“ï¼šç´„ ${l} åˆ† ${c} ç§’`}t.forEach(t=>{const e=document.createElement("div"),o=document.createElement("input");o.type="checkbox",e.appendChild(o),e.appendChild(document.createTextNode(" "+t.textContent.trim())),n.appendChild(e),x.push({cb:o,url:t.href})}),document.body.appendChild(n),e.onclick=()=>{n.style.display="none"===n.style.display?"block":"none"},o.onclick=async()=>{const t=Date.now(),e=[],n=x.filter(t=>t.cb.checked);if(0===n.length)return void alert("è«‹å…ˆé¸æ“‡ç« ç¯€");o.disabled=!0,o.textContent="ğŸ“¦ æ‰“åŒ…ä¸­...",r.style.display="block";const i=new JSZip,l=c.checked;let a=0;const m=n.length;if(l){const o=n.map((n,o)=>async()=>{try{const t=await u(n.url);if(!t)throw new Error("å…§å®¹ç©ºç™½");return p.textContent="ç›®å‰ç« ç¯€ï¼š"+t.title,{index:o+1,title:t.title,text:t.text}}catch(t){const o=n.cb.parentNode.textContent.trim();return e.push(o),null}finally{a++,y(a,m),f(a,m,t)}}),l=await async function(t,e){const n=[];let o=0;return await Promise.all(Array.from({length:Math.min(e,t.length)},async function(){for(;o<t.length;){const e=o++;n[e]=await t[e]()}})),n}(o,4);l.filter(Boolean).forEach(t=>{const e=t.title.replace(/[\\/:*?"<>|]/g,"_");i.file(`${String(t.index).padStart(3,"0")} - ${e}.txt`,t.text)})}else{let o=1;for(const l of n){try{const t=await u(l.url);if(!t)throw new Error("å…§å®¹ç©ºç™½");p.textContent="ç›®å‰ç« ç¯€ï¼š"+t.title;const e=t.title.replace(/[\\/:*?"<>|]/g,"_");i.file(`${String(o).padStart(3,"0")} - ${e}.txt`,t.text)}catch(t){const n=l.cb.parentNode.textContent.trim();e.push(n)}a++,y(a,m),f(a,m,t),o++,await new Promise(t=>setTimeout(t,500))}}const h=await i.generateAsync({type:"blob"}),g=URL.createObjectURL(h),b=document.createElement("a");b.href=g,b.download="ESJ_å°èªªç« ç¯€.zip",b.click(),URL.revokeObjectURL(g),e.length>0?(s.style.display="block",s.textContent=`âŒ å¤±æ•—ç« ç¯€ï¼ˆ${e.length}ï¼‰ï¼š\n`+e.join("ã€")):(s.style.display="block",s.textContent="âœ… å…¨éƒ¨ç« ç¯€ä¸‹è¼‰æˆåŠŸ"),o.textContent="ğŸ“¦ ä¸‹è¼‰é¸å–ç« ç¯€ï¼ˆZIPï¼‰",o.disabled=!1,p.textContent="ç›®å‰ç« ç¯€ï¼šå…¨éƒ¨å®Œæˆ ğŸ‰",d.textContent="å‰©é¤˜æ™‚é–“ï¼š0 ç§’"};let g=!1;i.onclick=()=>{g=!g,x.forEach(t=>t.cb.checked=g),i.textContent=g?"âŒ å–æ¶ˆå…¨é¸":"âœ… å…¨é¸"}}();