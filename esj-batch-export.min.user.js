// ==UserScript==
// @name         ESJ ç›®éŒ„æ‰¹æ¬¡ä¸‹è¼‰ TXTï¼ˆé è¨­ ZIPï¼‰
// @namespace    esj-batch-export
// @version      1.5
// @description  åœ¨å°èªªç›®éŒ„é å‹¾é¸ç« ç¯€ä¸¦ç›´æ¥ ZIP æ‰¹æ¬¡ä¸‹è¼‰ TXT
// @match        https://www.esjzone.cc/detail/*.html
// @grant        none
// @require      https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js
// @require      https://cdn.jsdelivr.net/npm/opencc-js@1.0.5/dist/umd/full.js
// @downloadURL  https://raw.githubusercontent.com/sakakibara-yoichi/esj-novel-batch-export/master/esj-batch-export.min.user.js
// @updateURL    https://raw.githubusercontent.com/sakakibara-yoichi/esj-novel-batch-export/master/esj-batch-export.min.user.js
// ==/UserScript==
!async function(){"use strict";const t=Array.from(document.querySelectorAll('#chapterList a[href*="/forum/"]')).filter(t=>t.textContent.trim().length>0);if(0===t.length)return;const e=document.createElement("div");e.textContent="ğŸ“˜",e.title="ä¸‹è¼‰ç« ç¯€ TXT",Object.assign(e.style,{position:"fixed",right:"20px",bottom:"20px",zIndex:9999,cursor:"pointer",fontSize:"28px",background:"#fff",border:"1px solid #aaa",borderRadius:"50%",width:"48px",height:"48px",display:"flex",alignItems:"center",justifyContent:"center",boxShadow:"0 2px 6px rgba(0,0,0,.3)"}),document.body.appendChild(e);const n=document.createElement("div");Object.assign(n.style,{position:"fixed",right:"20px",bottom:"80px",zIndex:9999,background:"#fff",border:"1px solid #aaa",padding:"10px",width:"320px",maxHeight:"60vh",overflowY:"auto",fontSize:"14px",display:"none",boxShadow:"0 2px 8px rgba(0,0,0,.3)"});const o=document.createElement("button");o.textContent="ğŸ“¦ ä¸‹è¼‰é¸å–ç« ç¯€ï¼ˆZIPï¼‰",o.style.width="100%",o.style.marginBottom="8px";const i=document.createElement("button");i.textContent="âœ… å…¨é¸",i.style.width="100%",i.style.marginBottom="6px",n.appendChild(i),n.appendChild(o),n.appendChild(document.createElement("hr"));const c=document.createElement("label");c.style.display="block",c.style.marginBottom="8px",c.style.cursor="pointer";const l=document.createElement("input");l.type="checkbox",l.style.marginRight="6px",c.appendChild(l),c.appendChild(document.createTextNode("âš¡ åŠ é€Ÿæ¨¡å¼ï¼ˆä½µç™¼ä¸‹è¼‰ï¼‰")),n.appendChild(c);const r=document.createElement("label");r.style.display="block",r.style.marginBottom="8px",r.style.cursor="pointer";const a=document.createElement("input");a.type="checkbox",a.style.marginRight="6px",r.appendChild(a),r.appendChild(document.createTextNode("ğŸ€„ ç°¡é«” â†’ ç¹é«”ï¼ˆOpenCCï¼‰")),n.appendChild(r);const d=document.createElement("div");d.style.display="none";const s=document.createElement("div");s.style.fontSize="12px",s.style.marginBottom="4px";const p=document.createElement("div");p.style.fontSize="12px",p.style.color="#666",p.style.marginBottom="4px",p.textContent="å‰©é¤˜æ™‚é–“ï¼šè¨ˆç®—ä¸­â€¦";const m=document.createElement("div");m.style.fontSize="12px",m.style.color="#c62828",m.style.marginTop="6px",m.style.display="none";const h=document.createElement("div");h.style.fontSize="12px",h.style.color="#555",h.style.marginBottom="4px",h.textContent="ç›®å‰ç« ç¯€ï¼šâ€”";const x=document.createElement("div");Object.assign(x.style,{width:"100%",height:"10px",background:"#eee",borderRadius:"5px",overflow:"hidden"});const u=document.createElement("div");Object.assign(u.style,{height:"100%",width:"0%",background:"#4caf50",transition:"width .2s"}),x.appendChild(u),d.appendChild(s),d.appendChild(x),d.insertBefore(h,s),d.insertBefore(p,s),d.appendChild(m),n.appendChild(d);const y=[];async function f(t){const e=await fetch(t).then(t=>t.text()),n=(new DOMParser).parseFromString(e,"text/html"),o=(n.title||"æœªå‘½åç« ç¯€").replace(" - ESJ Zone","").trim(),i=n.querySelector("div.forum-content.mt-3");if(!i)return null;i.querySelectorAll("script, style, img").forEach(t=>t.remove());let c=i.innerText.split("\n").map(t=>t.trim()).filter(Boolean).join("\n");a.checked&&(c=C(c));const l=a.checked?C(o):o;return{title:l,text:`${l}\n\n${c}`}}function g(t,e){const n=Math.floor(t/e*100);u.style.width=n+"%",s.textContent=`ä¸‹è¼‰ä¸­ï¼š${t} / ${e}ï¼ˆ${n}%ï¼‰`}function b(t,e,n){if(0===t)return;const o=(Date.now()-n)/1e3/t,i=Math.max(0,Math.round(o*(e-t))),c=Math.floor(i/60),l=i%60;p.textContent=`å‰©é¤˜æ™‚é–“ï¼šç´„ ${c} åˆ† ${l} ç§’`}t.forEach(t=>{const e=document.createElement("div"),o=document.createElement("input");o.type="checkbox",e.appendChild(o),e.appendChild(document.createTextNode(" "+t.textContent.trim())),n.appendChild(e),y.push({cb:o,url:t.href})}),document.body.appendChild(n),e.onclick=()=>{n.style.display="none"===n.style.display?"block":"none"};const C=OpenCC.Converter({from:"cn",to:"tw"});o.onclick=async()=>{const t=Date.now(),e=[],n=y.filter(t=>t.cb.checked);if(0===n.length)return void alert("è«‹å…ˆé¸æ“‡ç« ç¯€");o.disabled=!0,o.textContent="ğŸ“¦ æ‰“åŒ…ä¸­...",d.style.display="block";const i=new JSZip,c=l.checked;let r=0;const a=n.length;if(c){const o=n.map((n,o)=>async()=>{try{const t=await f(n.url);if(!t)throw new Error("å…§å®¹ç©ºç™½");return{index:o+1,title:t.title,text:t.text}}catch(t){const o=n.cb.parentNode.textContent.trim();return e.push(o),null}finally{r++,g(r,a),b(r,a,t)}}),c=await async function(t,e){const n=[];let o=0;return await Promise.all(Array.from({length:Math.min(e,t.length)},async function(){for(;o<t.length;){const e=o++;n[e]=await t[e]()}})),n}(o,4);c.map((t,e)=>({...t,index:e+1})).filter(Boolean).sort((t,e)=>t.index-e.index).forEach(t=>{const e=t.title.replace(/[\\/:*?"<>|]/g,"_").trim();i.file(`${String(t.index).padStart(3,"0")} - ${e}.txt`,t.text)})}else{for(let o=0;o<n.length;o++){const c=n[o];try{const t=await f(c.url);if(!t)throw new Error("å…§å®¹ç©ºç™½");h.textContent="ç›®å‰ç« ç¯€ï¼š"+t.title;const e=t.title.replace(/[\\/:*?"<>|]/g,"_").trim();i.file(`${String(o+1).padStart(3,"0")} - ${e}.txt`,t.text)}catch(t){const n=c.cb.parentNode.textContent.trim();e.push(n)}r++,g(r,a),b(r,a,t),await new Promise(t=>setTimeout(t,500))}}const s=await i.generateAsync({type:"blob"}),x=URL.createObjectURL(s),u=document.createElement("a");u.href=x,u.download="ESJ_å°èªªç« ç¯€.zip",u.click(),URL.revokeObjectURL(x),e.length>0?(m.style.display="block",m.textContent=`âŒ å¤±æ•—ç« ç¯€ï¼ˆ${e.length}ï¼‰ï¼š\n`+e.join("ã€")):(m.style.display="block",m.textContent="âœ… å…¨éƒ¨ç« ç¯€ä¸‹è¼‰æˆåŠŸ"),o.textContent="ğŸ“¦ ä¸‹è¼‰é¸å–ç« ç¯€ï¼ˆZIPï¼‰",o.disabled=!1,h.textContent="ç›®å‰ç« ç¯€ï¼šå…¨éƒ¨å®Œæˆ ğŸ‰",p.textContent="å‰©é¤˜æ™‚é–“ï¼š0 ç§’"};let w=!1;i.onclick=()=>{w=!w,y.forEach(t=>t.cb.checked=w),i.textContent=w?"âŒ å–æ¶ˆå…¨é¸":"âœ… å…¨é¸"}}();